---
title: "2020-05-18 - Environment Change Rate Sweeps - Experiment Analysis"
output:
  html_document:
    keep_md: no
    toc: true
    toc_float: true
    toc_depth: 4
    collapsed: false
    theme: default
    code_folding: hide
  pdf_document:
    toc: true
    toc_depth: 4
---

## Analysis Dependencies

```{r, message=FALSE}
library(ggplot2)  # (Wickham, 2016)
library(tidyr)    # (Wickham and Henry, 2020)
library(dplyr)    # (Wickham et al., 2020)
library(reshape2) # (Wickham, 2007)
library(cowplot)  # (Wilke, 2019)
```


We conducted these analyses using the following computing environment:

```{r}
print(version)
```

## Setup

```{r}
data_path <- "./data/agg_data.csv"
agg_data <- read.csv(data_path, na.strings="NONE")

agg_data$BIT_FLIP_PROB <- as.factor(agg_data$BIT_FLIP_PROB)
agg_data$DRIFT <- agg_data$TOURNAMENT_SIZE==1

# Compute expected changes per generation
exp_change <- function(mag, interval) {
  if (interval == 0) { return(0) }
  else { return(mag / interval) }
}

# Label
chg_rate_label <- function(mag, interval, drift) {
  if (drift) { return("drift") }
  else if (interval == 0) { return("0") }
  else { return(paste(mag, interval, sep="/")) }
}

agg_data$EXP_CHANGE_PER_GEN <- as.factor(mapply(exp_change, 
                                                agg_data$CHANGE_MAGNITUDE,
                                                agg_data$CHANGE_FREQUENCY
                                                ))
agg_data$chg_rate_label <- factor(mapply(chg_rate_label, 
                                            agg_data$CHANGE_MAGNITUDE,
                                            agg_data$CHANGE_FREQUENCY,
                                            agg_data$DRIFT),
                                     levels=c("drift", "0", "1/256", "1/128",
                                              "1/64", "1/32", "1/16", "1/8",
                                              "1/4", "1/2", "1/1", "2/1", 
                                              "4/1", "8/1", "16/1", "32/1",
                                              "64/1", "128/1", "256/1", 
                                              "512/1", "1024/1", "2048/1",
                                              "4096/1"))
theme_set(theme_cowplot())
```

## Analysis

## Genetic architecture by change rate

### Genetic architecture by change rate - Gradient fitness model

```{r}
gradient_model <- 1
phase <- 0
gen <- 50000
data_gradient <- filter(agg_data, GRADIENT_MODEL == gradient_model & 
                         evo_phase == phase & 
                         update == gen)
ggplot(data_gradient,
       aes(x=chg_rate_label, y=coding_sites, color=chg_rate_label)) +
  geom_boxplot() +
  xlab("Env. bits flipped per generation") +
  scale_y_continuous(name="# coding sites in best organism",
                     limits=c(0, 130),
                     breaks=seq(0, 130, 10)) +
  ggtitle("Gradient Fitness Model") +
  theme(legend.position="none") +
  ggsave(paste("./imgs/coding-sites_x_chg-rate_gradient", 
               "_phase-", phase, "_gen-", gen, 
               ".pdf", sep=""), width=10, height=5)

```

```{r}
kruskal.test(formula = coding_sites ~ chg_rate_label, data=data_gradient)
pairwise.wilcox.test(x=data_gradient$coding_sites,
                     g=data_gradient$chg_rate_label,
                     exact=FALSE,
                     p.adjust.method = "holm")
```

Genome length

```{r}
ggplot(data_gradient,
       aes(x=chg_rate_label, y=genome_length, color=chg_rate_label)) +
  geom_boxplot() +
  xlab("Env. bits flipped per generation") +
  ylab("genome length") +
  ylim(0, 1024) +
  ggtitle("Gradient Fitness Model") +
  theme(legend.position="none") +
  ggsave(paste("./imgs/genome-length_x_chg-rate_gradient", 
               "_phase-", phase, "_gen-", gen, 
               ".pdf", sep=""), width=10, height=5)

```

### Coding sites by change rate - NK fitness model

```{r}
gradient_model <- 0
phase <- 0
gen <- 50000
data_nk <- filter(agg_data, GRADIENT_MODEL == gradient_model & 
                         evo_phase == phase & 
                         update == gen)
ggplot(data_nk,
       aes(x=chg_rate_label, y=coding_sites, color=chg_rate_label)) +
  geom_boxplot() +
  xlab("Env. bits flipped per generation") +
  scale_y_continuous(name="# coding sites in best organism",
                     limits=c(0, 130),
                     breaks=seq(0, 130, 10)) +
  ggtitle("NK Fitness Model") +
  theme(legend.position="none") +
  ggsave(paste("./imgs/coding-sites_x_chg-rate_nk", 
               "_phase-", phase, "_gen-", gen, 
               ".pdf", sep=""), width=10, height=5)
```

```{r}
kruskal.test(formula = coding_sites ~ chg_rate_label, data=data_nk)
pairwise.wilcox.test(x=data_nk$coding_sites,
                     g=data_nk$chg_rate_label,
                     exact=FALSE,
                     p.adjust.method = "holm")
```

```{r}
ggplot(data_nk,
       aes(x=chg_rate_label, y=genome_length, color=chg_rate_label)) +
  geom_boxplot() +
  xlab("Env. bits flipped per generation") +
  ylab("genome length") +
  ylim(0, 1024) +
  ggtitle("NK Fitness Model") +
  theme(legend.position="none") +
  ggsave(paste("./imgs/genome-length_x_chg-rate_nk", 
               "_phase-", phase, "_gen-", gen, 
               ".pdf", sep=""), width=10, height=5)

```

## Lock-down fitnesses by change rate

### Gradient model


```{r}
gradient_model <- 1
phase <- 1
gen <- 60000
data_gradient <- filter(agg_data, GRADIENT_MODEL == gradient_model & 
                         evo_phase == phase & 
                         update == gen)
ggplot(data_gradient,
       aes(x=chg_rate_label, y=fitness, color=chg_rate_label)) +
  geom_boxplot() +
  xlab("Env. bits flipped per generation") +
  scale_y_continuous(name="phase 2 fitness") +
  ggtitle("Gradient Fitness Model") +
  theme(legend.position="none") +
  ggsave(paste("./imgs/fitness_x_chg-rate_gradient", 
               "_phase-", phase, "_gen-", gen, 
               ".pdf", sep=""), width=10, height=5)
```

### NK model

```{r}
gradient_model <- 0
phase <- 1
gen <- 60000
data_nk <- filter(agg_data, GRADIENT_MODEL == gradient_model & 
                         evo_phase == phase & 
                         update == gen)
ggplot(data_nk,
       aes(x=chg_rate_label, y=fitness, color=chg_rate_label)) +
  geom_boxplot() +
  xlab("Env. bits flipped per generation") +
  scale_y_continuous(name="phase 2 fitness") +
  ggtitle("NK Fitness Model") +
  theme(legend.position="none") +
  ggsave(paste("./imgs/fitness_x_chg-rate_nk", 
               "_phase-", phase, "_gen-", gen, 
               ".pdf", sep=""), width=10, height=5)
```

## Genetic architecture lock-down fitnesses by change rate

## Lock-down fitness vs coding sites

### Gradient model

```{r}
# Look at phase 1 representative organism coding sites
gradient_model <- 1
phase <- 1
gen <- 60000
data_gradient <- filter(agg_data, GRADIENT_MODEL == gradient_model & 
                         evo_phase == phase & 
                         update == gen)
ggplot(data_gradient,
       aes(x=coding_sites, y=fitness, color=chg_rate_label)) +
  geom_point() +
  xlab("coding sites") +
  ylab("fitness") +
  theme(legend.position="top") +
  ggsave(paste("./imgs/fitness_x_coding_gradient", 
               "_phase-", phase, "_gen-", gen, 
               ".pdf", sep=""), width=10, height=10)
```

```{r}
cor.test(x=data_gradient$coding_sites, 
         y=data_gradient$fitness,
         method="spearman",
         conf.level=0.95)
```

### NK model

```{r}
# Look at phase 1 representative organism coding sites
gradient_model <- 0
phase <- 1
gen <- 60000
data_nk <- filter(agg_data, GRADIENT_MODEL == gradient_model & 
                         evo_phase == phase & 
                         update == gen)
ggplot(data_nk,
       aes(x=coding_sites, y=fitness, color=chg_rate_label)) +
  geom_point() +
  xlab("coding sites") +
  ylab("fitness") +
  theme(legend.position="top") +
  ggsave(paste("./imgs/fitness_x_coding_nk", 
               "_phase-", phase, "_gen-", gen, 
               ".pdf", sep=""), width=10, height=10)
```

```{r}
cor.test(x=data_nk$coding_sites, 
         y=data_nk$fitness,
         method="spearman",
         conf.level=0.95)
```


